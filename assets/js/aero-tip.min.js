"use strict";Aero.tip={options:{labels:{end:AeroStep.lang.finished,next:AeroStep.lang.next,prev:AeroStep.lang.prev},template:function(f){var c="",g="";var h=f.position?f.position:"top";var b=Aero.tip._current+1;var e=Aero.tip._guide.step.length;var d=(b/e)*100;if(isNaN(f.size)){c=(f.size&&f.size!="")?" aero-tip-"+f.size:""}else{c="' style='width:"+f.size+"px'"}if(f.showTitle){g='<div class="aero-tip-title">'+f.title+"</div>"}var a=f.multi?"":"<div class='aero-tip-nav clearfix'><div class='aero-progress'><span>"+b+" of "+e+"</span><span class='aero-needle'><span style='width:"+d+"%'></span></span></div></div>";return"<div id='"+f.id+"' class='aero-tip aero-tip-"+h+c+"' style='display:none'><div class='aero-tip-arrow'></div><div class='aero-tip-body'>"+g+f.body+"</div>"+a+"</div>"}},setGuide:function(c,b){var a=this;a._guide=false;Aero.model.guide.byId(c,function(d){a._guide=d;Aero.view.step.render(a._guide);localStorage.setItem("aero:session",JSON.stringify(a._guide));if(b){b()}})},setStep:function(a,b){this._current=a;if(!b){localStorage.setItem("aero:session:current",a)}},redirect:function(a,h){var c=false;var d=/#$/;var b=/\/$/;var g=document.URL;var f=location.protocol+"//"+location.hostname+(location.port?":"+location.port:"");if(a=="/#/"){c=true}if(!a){a=""}a=f+a;if(!c){if(d.test(g)){g=g.replace("#","")}if(b.test(g)){g=g.slice(0,-1)}}a=AeroStep.getSubURL(a);if(h=="all"){return false}if(h=="par"){g=g.split("?")[0];a=a.split("?")[0]}if(h=="anc"){g=g.split("#")[0];a=a.split("#")[0]}if(g!=a){var e=localStorage.getItem("aero:session:404");var i=(e)?(parseInt(e)+1):0;localStorage.setItem("aero:session:404",i);if(i>1){Aero.confirm({ok:AeroStep.lang.done,title:AeroStep.lang.notfound,msg:AeroStep.lang.urlloop+"</br></br><strong>"+a+"</strong>",onConfirm:function(){Aero.tip.stop()}})}else{window.location=a}return true}return false},start:function(c,b){var a=b?b:0;this._forward=true;this.setGuide(c,function(){if(Aero.constants.USERNAME){Aero.audit.init()}});this.setNav();this.setStep(a);b=Aero.step.get(this._current);this.beforeShow(a,b)},stop:function(){var a=this.isReturnBranch();if(!a){if(Aero.tip._guide.step&&Aero.tip._current==(Aero.tip._guide.step.length-1)){this.sayCongrats()}this.setStep(null);this.hide(this._current);clearInterval(this.ob);Aero.tip._guide=null;AeroStep.session.destroy();Aero.guide.init()}},next:function(){var a=Aero.step.get(this._current);this._forward=true;clearInterval(this.ob);localStorage.removeItem("aero:session:fake");if(a.next!=-1){this.hide(this._current);this.beforeShow(a.next,a)}},prev:function(){var a=Aero.step.get(this._current);this._forward=false;clearInterval(this.ob);localStorage.removeItem("aero:session:fake");if(a.prev!=-1){this.hide(this._current);this.beforeShow(a.prev,a)}},jumpTo:function(a){var b=Aero.step.get(a);this._forward=true;clearInterval(this.ob);Aero.jump=true;localStorage.removeItem("aero:session:fake");if(b){this.hide(this._current);this.beforeShow(a,b)}},findStep:function(b){var a=false;if(b.loc){a=b.isFrame?$q(b.framePath).contents().find(b.loc):$q(b.loc);if(a.length===0||!a.is(":visible")||a.css("visibility")=="hidden"){a=false}}return a},findStepTimeout:function(c,b){var a=this;if(Aero.hashChange){return}if(a.tries<c*2){setTimeout(function(){a.hide(b-1);a.show(b);a.tries++},500)}else{Aero.view.step.setState(b,"missing");a.show(b+1)}},observe:function(b){var a=this;Aero.log("Observe","info");var c=Aero.step.get(b);a.ob=setInterval(function(){Aero.log("Observing","info");var d=a.findStep(c);if(d){a.next()}if(d||b!=a._current+1){clearInterval(a.ob)}},500)},beforeShow:function(i,step){var self=this;self.tries=1;var wait=200;var before=(this._forward)?step.beforeCode:this._guide.step[i].beforeCode;if(step.pause){wait=parseInt(step.pause)*1000}if(before){try{eval(before)}catch(err){Aero.log("Before show code is broken: "+err,"error")}}setTimeout(function(){if(!Aero.hashChange){self.show(i)}},wait)},show:function(b,h){var g,a,e;if(Aero.tip._guide.step.length==0){return}if(typeof b=="undefined"){b=this._current}if(!Aero.tip._guide||b>Aero.tip._guide.step.length||b<0){return}localStorage.setItem("aero:session:forward",true);e=Aero.step.get(b);if(e.sidebar){Aero.view.sidebar.hide()}else{var c=localStorage.getItem("aero:sidebar:open");if(!$q(".aero-sidebar").hasClass("open")&&c=="1"){Aero.view.sidebar.show()}}a=this.findStep(e,b);this.setStep(b,h);if(localStorage.getItem("aero:session:fake")&&localStorage.getItem("aero:session:forwardUrl")!==document.URL){Aero.view.step.setState(localStorage.getItem("aero:session:fake"),"forward");return}else{if(this.redirect(e.url,e.noUrl)){return}}localStorage.removeItem("aero:session:404");if(a){Aero.log("Found Step "+b,"success");Aero.audit.update();if(AeroStep.admin){localStorage.setItem("aero:session:fake",b);localStorage.setItem("aero:session:forwardUrl",document.URL)}if(e.branch){e.position="orphan";e.size=500}g=$q(this.options.template(e));if(e.branch){g=this.renderBranch(g,e.branch,e.branchstep,e["return"])}else{g=this.buildNav(g,e)}$q("body").append(g);Aero.view.step.setState(b);this.setPosition(a,g,e.position);this.setEvents(a,e.nav,g,e.position);this.scrollToElement(a)}else{if(e.alert){this.renderException(e.alert,e.alertContent)}else{if(e.miss=="back"){Aero.view.step.setState(b,"missing");this.prev()}else{if(e.tries&&e.tries>0){this.findStepTimeout(e.tries,b);return}else{if(!e.multi){Aero.log("Skipping step: "+b+" with loc:"+e.loc,"error");Aero.view.step.setState(b,"missing");if(b<Aero.tip._guide.step.length){if(this._forward){this.next()}else{this.prev()}}}}}}}var f=(this._forward)?1:-1;var j=false;if(this._forward&&Aero.step.get(b+f).multi||!this._forward&&e.multi){j=true}if(Aero.jump&&e.multi){j=true;f=-1;this._forward=false}if(j){this.show(b+f,true)}Aero.jump=null},hide:function(i){var step=Aero.step.get(i);$q(".aero-active").removeClass("aero-active");$q(".aero-tip").remove();if(step.afterCode){try{eval(step.afterCode)}catch(err){Aero.log("After hide code is broken: "+err,"error")}}},buildNav:function(c,d){var e="";var b=false;for(var a in d.nav){if(d.nav.click!=undefined||d.nav.hover!=undefined){b=true}}if(!d.noNav){if(d.next==-1){e+="<a class='aero-btn-end'>"+this.options.labels.end+"</a>"}if(!d.noNext&&!b&&d.next!=-1){e+="<a class='aero-btn-next'>"+this.options.labels.next+"</a>"}if(!d.noPrev&&d.prev!=-1){e+="<a class='aero-btn-prev'>"+this.options.labels.prev+"</a>"}}c.find(".aero-tip-nav").append(e);return c},setPosition:function(j,b,c){var h={};var a=j.offset();var e=b.outerWidth()/2;var d=b.outerHeight();var i=a.left+(j.outerWidth()/2);var g=a.top+(j.outerHeight()/2);var f=b.find(".aero-tip-arrow");h.tLeft=e-(f.outerWidth()/2);h.tTop=(b.outerHeight()/2)-(f.outerHeight()/2);switch(c){case"top":h.left=i-e;h.top=a.top-d-b.find(".aero-tip-arrow").outerHeight();break;case"bottom":h.left=i-e;h.top=a.top+j.outerHeight();break;case"left":h.left=a.left-b.outerWidth()-b.find(".aero-tip-arrow").outerWidth();h.top=g-(d/2);break;case"right":h.left=a.left+j.outerWidth();h.top=g-(d/2);break;case"orphan":h.left=$q(window).width()/2-e;h.top=$q(window).height()/2-(d/2);break}h=this.containIn(document,b,h,c);$q(".aero-tip-top, .aero-tip-bottom").each(function(){f.css({left:h.tLeft})});$q(".aero-tip-left, .aero-tip-right").each(function(){f.css({top:h.tTop})});$q(".aero-tip-top").each(function(){f.css({top:"auto"})});b.css({left:h.left,top:h.top})},containIn:function(b,f,h,g){var d=$q(b).height();var i=$q(window).width();var e=h.left+f.outerWidth()-i;var c=h.top+f.outerHeight()-d;if(e>0){if(g=="bottom"||g=="top"){h.tLeft+=e}h.left-=e}if(h.left<0){if(g=="bottom"||g=="top"){h.tLeft+=h.left}h.left-=h.left}if(h.top<0){if(g=="left"||g=="right"){h.tTop+=h.top}h.top-=h.top}if(c>0&&g=="bottom"){if(g=="left"||g=="right"){h.tTop+=c}h.top-=c}var a=h.left+f.outerWidth();if(a>(i-270)){Aero.view.sidebar.hide()}else{if(localStorage.getItem("aero:sidebar:open")=="1"){Aero.view.sidebar.show();if(g=="orphan"){h.left-=115}}}return h},scrollToElement:function(a){var b=$q(".aero-tip:eq(0)");b.show();if(!a.visible()){$q("body, html").stop().animate({scrollTop:b.offset().top-($q(window).height()/2)+(b.height())},750,function(){$q(".aero-tip").fadeIn(200)});b.hide()}else{b.hide();$q(".aero-tip").fadeIn(200)}$q(".aero-tip").fadeIn(200)},isReturnBranch:function(){var b=localStorage.getItem("aero:session:branch:returnid");var a=localStorage.getItem("aero:session:branch:returnto");if(!b){return false}localStorage.removeItem("aero:session:branch:returnid");localStorage.removeItem("aero:session:branch:returnto");Aero.confirm({ok:"Return",cancel:"End Guide",title:"Branch complete",msg:"You have completed this branch, we will now move you back to the original guide.",onConfirm:function(){Aero.tip.hide();Aero.tip.start(b,parseInt(a))},onCancel:function(){Aero.tip.stop()}});return true},renderBranch:function(e,b,d,c){var a=e.find(".aero-tip-body").html();e.find(".aero-tip-body").html("Please select one of the following choices: <div class='aero-branch'><a data-returnid='"+Aero.tip._guide.id+"' data-returnto='"+c+"' data-guideid='"+b+"' class='aero-start'>"+a+"</a><a class='aero-continue'>Continue with this guide</a></div>");return e},renderException:function(b,a){Aero.confirm({ok:"End Guide",title:b,msg:a,onConfirm:function(){Aero.tip.stop()}})},setNav:function(){var a=this;$q("body").off("click.aNe").on("click.aNe",".aero-btn-next",function(){a.next()}).off("click.aPe").on("click.aPe",".aero-btn-prev",function(){a.prev()}).off("click.aEd").on("click.aEd",".aero-btn-end",function(){a.stop()})},sayCongrats:function(){var b=localStorage.getItem("aero:session");var a=JSON.parse(b);if(!AeroStep.admin){Aero.confirm({ok:AeroStep.lang.done,title:AeroStep.lang.gfinished,msg:AeroStep.lang.congrats+a.title,onConfirm:function(){AeroStep.session.destroy()}})}},setEvents:function(c,f,e,a){var b=this,d=false;$q(document).off("scroll.scw").on("scroll.scw"+Aero.tip._current,function(){b.setPosition(c,e,a)},250);$q("div *").off("scroll.scd").on("scroll.scd"+Aero.tip._current,function(){b.setPosition(c,e,a)},250);$q(window).on("resize",function(){b.setPosition(c,e,a);Aero.view.sidebar.setScrollable()},250);localStorage.removeItem("aero:session:end");if(Aero.tip._current==(Aero.tip._guide.step.length-1)){localStorage.setItem("aero:session:end",1);d=true}$q("body").off("click.branchc").on("click.branchc",".aero-continue",function(){Aero.tip.next()});$q("body").off("click.branchs").on("click.branchs",".aero-start",function(){localStorage.setItem("aero:session:branch:returnid",$q(this).data("returnid"));localStorage.setItem("aero:session:branch:returnto",$q(this).data("returnto"));Aero.tip.hide();Aero.tip.start($q(this).data("guideid"),0)});for(var g in f){if(f.hasOwnProperty(g)){if(f[g]==-1){f[g]=Aero.tip._current+1}switch(g){case"click":c.off("click.aeronav").on("click.aeronav",c,function(){if(d){if(!AeroStep.admin){b.stop()}return}b.setStep(f[g]);b.jumpTo(f[g])});break;case"hover":c.off("mouseenter.aeronav").on("mouseenter.aeronav",c,function(){setTimeout(function(){b.jumpTo(f[g])},500)});break;case"blur":c.focus();c.off("keydown.aeronav").on("keydown.aeronav",c,function(i){var h=i.keyCode||i.which;if(h==13||h==9){b.jumpTo(f[g])}});break;case"unload":$q(window).off("beforeunload.aeronav").on("beforeunload.aeronav",function(){b.setStep(f[g])});break;case"observe":b.observe(b._current+1);break}}}}};