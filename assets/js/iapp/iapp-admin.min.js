var Paper=can.Control({defaults:{rect:{minWidth:20,fminHeight:20}}},{init:function(){this.element.on("mousedown.paper:not('.stop')",$.proxy(this.startDrawRect,this))},startDrawRect:function(e){var c=this.element.offset();this.canvasOffsetLeft=c.left;this.canvasOffsetTop=c.top;this.drawStartX=e.pageX-this.canvasOffsetLeft;this.drawStartY=e.pageY-this.canvasOffsetTop;this.drawingRect=this.createRect(this.drawStartX,this.drawStartY,0,0);this.element.on("mousemove.paper",$.proxy(this.drawRect,this));this.element.on("mouseup.paper",$.proxy(this.endDrawRect,this))},drawRect:function(g){var h=g.pageX-this.canvasOffsetLeft;var e=g.pageY-this.canvasOffsetTop;var f=this.calculateRectPos(this.drawStartX,this.drawStartY,h,e);this.drawingRect.css(f)},endDrawRect:function(g){var h=g.pageX-this.canvasOffsetLeft;var e=g.pageY-this.canvasOffsetTop;var f=this.calculateRectPos(this.drawStartX,this.drawStartY,h,e);if(f.width<this.options.rect.minWidth||f.height<this.options.rect.minHeight){this.drawingRect.remove()}else{this.drawingRect.css(f);this.selectRect(this.drawingRect);$del=$('<span class="del stop">x</span>');this.drawingRect.append($del);this.drawingRect.attr("id","r-"+this.getUUID());PageApiAdmin.assignStep(this.getUUID()-1)}this.element.off("mousemove.paper");this.element.off("mouseup.paper")},getUUID:function(){var e=false;var c=0;while(!e){c++;e=$("#r-"+c).length==0}return c},createRect:function(f,g,e,h){return $("<a/>").addClass("rect stop").css({left:f,top:g,width:e,height:h}).appendTo(this.element)},selectRect:function(b){this.selectedRect&&this.selectedRect.removeClass("selected");this.selectedRect=b;this.selectedRect.addClass("selected")},calculateRectPos:function(p,i,m,n){var o=m-p;var j=n-i;var k=p;var l=i;if(o<0){o=Math.abs(o);k-=o}if(j<0){j=Math.abs(j);l-=j}return{left:k,top:l,width:o,height:j}}});var PageApiAdmin={assignStep:function(a){Aero.tpl.get("iappstep-form.html",function(c){var e=this;var b=_q.template(c);Aero.confirm({ok:"ok",title:"Link to page?",msg:b({pages:pageTitles}),onValidate:function(){return $q("form").isFormValid()},onConfirm:function(){var f=false;var g=$("#iPage").val();if(g=="inew"){g=$("#ititle").val();f=true}if(g!=""){$("#r-"+a).attr("href",g)}if(f){PageApiAdmin.createPage($("#ititle").val())}},onCancel:function(){$("#r-"+a).remove()}})})},createPage:function(b){var c=this;var a={featureid:featureid,title:b,index:pageTitles.length+1,desc:""};Aero.send("api/pages",a,function(e){c.save(function(){window.location=b})},"POST")},save:function(c){var b=[];$(".rect").each(function(){var e={};e.width=$(this).outerWidth();e.height=$(this).outerHeight();e.left=$(this).css("left").replace("px","");e.top=$(this).css("top").replace("px","");e.link=$(this).attr("href");b.push(e)});var a={id:pageid,istep:b};console.log(a);this.send("api/pages",a,function(e){if(c){c()}else{window.location="/app/"+host+"/features/"+feature}},"PUT")},send:function(b,e,f,c){if(!c){c="GET"}if(!e.host){e.host=host}if(c=="POST"||c=="PUT"){e=JSON.stringify(e)}b="/"+b;var a={async:false,type:c,data:e,dataType:"json",contentType:"application/json",url:b,success:function(g){if(f){f(g)}},error:function(i,h){var g=b+" says: "+JSON.stringify(i)+" "+JSON.stringify(h);Aero.log(JSON.stringify(g))}};if(c=="GET"){a.dataType="jsonp"}$.ajax(a)},setUpload:function(){var a=$("#upload");var b={buttonImage:"",swf:"/assets/js/third_party/uploadify/uploadify.swf",buttonClass:"secondary small button",buttonText:"Upload Image",uploader:"/api/import_iapp",width:150,height:42,multi:false,fileTypeDesc:"Image Files",fileTypeExts:"*.png",onUploadStart:function(){a.uploadify("settings","formData",{timestamp:"<? echo time(); ?>",token:'<? echo md5("unique_salt" . time()); ?>',name:pageid})},onUploadSuccess:function(c){d=new Date();$(".screen").attr("src","/assets/images/iapp/"+pageid+".png?"+d.getTime())},onUploadError:function(){alert("Error")}};a.uploadify(b)},setEvents:function(){var a=this;$("body").on("mousedown",".del",function(){$(this).parent().remove()});$("body").on("mousedown","a.rect",function(){window.location=$(this).attr("href")});$(".save").on("click",function(){a.save();return false});$(".cancel").on("click",function(){window.location="/app/"+host+"/features/"+feature;return false});$("body").on("change","#iPage",function(){$(".inewinput").hide();$(".inewinput input").removeClass("aero-required");if($(this).val()=="inew"){$(".inewinput").show();$(".inewinput input").addClass("aero-required")}})}};$(function(){var a=new Paper("#canvas",{});PageApiAdmin.setEvents();PageApiAdmin.setUpload()});