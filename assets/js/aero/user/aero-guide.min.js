"use strict";Aero.model.guide={url:"api/guides",urlSearch:"api/search",defaults:function(){return{title:"",active:false,steps:[]}},byId:function(b,a){Aero.guide.getAll(function(c){$q.each(c,function(e,d){if(d&&(b==d.id)){a(c[e]);aeroStorage.setItem("aero:session:index",e,function(){},true)}})})},update:function(b,a){Aero.guide.getAll(function(c){Aero.view.guide.render(c);if(b){b(a)}},true)},validate:function(){var a=$q("form").isFormValid();if($q("#aeroEditor").trumbowyg("html").replace(/<br>/g,"")==""){a=false;$q(".trumbowyg-editor").addClass("aero-require-error")}if(!a){$q("#aeroSection0 p:first").after('<div class="aero-error-box">'+AeroStep.lang.requirede+"</div>")}return a}};Aero.view.guide={render:function(c,d,b){var a=this;$q(".aero-restrict, .aero-contextual").remove();if(!b){a.clearSearch()}if($q(window).width()>500){Aero.tpl.get("sidebar-guides.html",function(e){aeroStorage.getItem("aero:sidebar:open",function(f){aeroStorage.getItem("aero:session:tab",function(h){$q("#aeroGuidebar").remove();var g=_q.template(e);$q("body").append(g({sidebar:f,guides:c}));$q("#aeroStepbar").remove();if(h>$q("#aeroGuidebar").outerHeight()){h=$q("#aeroGuidebar").outerHeight()-100}if(h<0){h=0}$q("#aero-tab").css("top",h+"px");a.setEvents();Aero.view.sidebar.setEvents();Aero.view.sidebar.setScrollable();var i=parseInt($q("body").data("newguides"));if(i>0){Aero.view.sidebar.notify(i)}},true)},true)})}},renderContextualTip:function(b,c){function a(f,d){var e=$q(Aero.tip.options.template(f));var g=b+"-"+d;e.attr("id","atip-"+g);e.addClass("aero-action-tip");$q("body").append(e);Aero.tip.setPosition($q("#aaction-"+g),$q("#atip-"+g),f.position);e.show()}Aero.guide.get(b,function(d){a(d.step[c],c)})},renderContextualAction:function(a){var e=this;if(!a.contextual||a.contextual.length==0){return}function d(g,j){var f,h;f=$q(j);if(f.length>0){var i=f.offset();h=$q("<a />").attr("id","aaction-"+a.id+"-"+g).addClass("aero-contextual").css({top:i.top+(f.outerHeight()/2)-8,left:i.left+(f.outerWidth())}).data("loc",j).data("guideid",a.id).data("step",parseInt(g));$q("body").append(h)}}for(var c in a.contextual){if(a.step.length>0){var b=parseInt(a.contextual[c]);if(a.step[b]&&a.step[b].loc){d(b,a.step[b].loc)}}}},renderRestrict:function(a){var d=this;if(a.isComplete||!a.restrict||a.restrict.length==0){return}function c(g,i,e){var f,h;f=$q(i);if(f.length>0){h=$q("<a />").addClass("aero-restrict").css({"background-color":e,cursor:"pointer",opacity:0.5}).data("loc",i).data("guideid",a.id).data("step",parseInt(g));$q("body").append(h);d.positionRestrict(h)}}for(var b in a.restrict){b=parseInt(b.replace("s",""));if(a.step.length>0){c(b,a.step[b].loc,a.step[b].restrictColor)}}},positionRestrict:function(b){var a=$q(b.data("loc"));var c=Aero.pos.isFixed(a)?"fixed":"absolute";b.css({width:a.outerWidth(),height:a.outerHeight(),top:a.offset().top,left:a.offset().left,position:c,"z-index":99999999})},search:function(b){var a=this;$q(".aero-search i").switchClass("fa-search","fa-times",0);$q(".aero-search a").switchClass("aero-search-btn","aero-search-clear",0);Aero.guide.getByTerm(b,function(c){c.search=b;a.render(c,function(){},true)})},clearSearch:function(){if($q(".aero-search-clear").length>0){$q(".aero-search i").switchClass("fa-times","fa-search",0);$q(".aero-search a").switchClass("aero-search-clear","aero-search-btn",0);$q(".aero-search").removeClass("aero-active");$q("input[name=aero_search]").val(AeroStep.lang.search)}},setEvents:function(){var a=this;$q("body").off("click.aeroStart").on("click.aeroStart",".aero-guides ul li > a",function(){var b=$q(this).parents("li:eq(0)").data("guideid");aeroStorage.removeItem("aero:session:pause");Aero.tip.start(b)});$q("body").off("click.apF").on("focus.apF",".aero-sidebar input[name=aero_search]",function(){$q(this).parents("div:eq(0)").addClass("aero-active");if($q(this).val()==AeroStep.lang.search){$q(this).val("")}});$q("body").off("click.apB").on("blur.apB",".aero-sidebar input[name=aero_search]",function(){if($q(this).val()==""){$q(this).parents("div:eq(0)").removeClass("aero-active");$q(this).val(AeroStep.lang.search)}});$q("body").off("click.aS").on("click.aS",".aero-search a.aero-search-btn",function(){a.search($q("input[name=aero_search]").val())});$q("body").off("keypress.asK").on("keypress.asK",".aero-sidebar input[name=aero_search]",function(c){var b=c.keyCode||c.which;if(b==13){a.search($q(this).val())}});$q("body").off("click.asC").on("click.asC",".aero-search-clear",function(){Aero.guide.getAll(function(b){a.render(b)});return false});$q("body").off("click.asr").on("click.asr",".aero-restrict",function(){var b=$q(this);Aero.confirm({ok:AeroStep.lang.ok,title:AeroStep.lang.restrictt,msg:AeroStep.lang.restrictb,onConfirm:function(){Aero.tip.start(b.data("guideid"))}})});$q("body").off("mouseenter.actip").on("mouseenter.actip",".aero-contextual",function(){var d=$q(this);var b=d.data("guideid");var c=d.data("step");$q(".aero-action-tip").remove();setTimeout(function(){a.renderContextualTip(b,c)},250)});$q("body").off("mouseleave.actip").on("mouseleave.actip",".aero-contextual",function(){$q(".aero-action-tip").remove()});$q("body").on("click",'input[name="aero_auto"]',function(){$q(".aero-auto-page").hide();if($q(this).is(":checked")){$q(".aero-auto-page").show()}})}};Aero.guide={init:function(){var b=this;var a=aeroStorage.getItem("aero:session:end");if(a){Aero.tip.sayCongrats()}b.getAll(function(c){aeroStorage.getItem("aero:session",function(f){var e=Aero.utils.getUrlParam("guideid");if(f){var d=JSON.parse(f);aeroStorage.getItem("aero:session:current",function(h){Aero.tip.start(d.id,parseInt(h))},true)}else{if(e){Aero.tip.start(Aero.utils.getUrlParam("guideid"));window.history.pushState("object or string","Title",window.location.href.replace("guideid","startedid"))}else{var g=aeroStorage.getItem("aero:pathway");if(g&&g!="0"){Aero.pathway.get(function(i){var h=Aero.view.pathway.render(i,parseInt(g));if(!h){Aero.view.guide.render(c)}})}else{Aero.view.guide.render(c)}}}},true)})},autoStart:function(a){Aero.view.guide.renderRestrict(a);Aero.view.guide.renderContextualAction(a);if(!a.auto){return}if(!a.isStarted&&!AeroStep.admin&&a.step.length>0){var b=false;if(a.autoPage){b=true}else{if(a.step.length>0&&window.location.pathname==a.step[0].url){b=true}}if(b){aeroStorage.setItem("aero:guide:auto",1);Aero.tip.start(a.id)}}},updateCache:function(a){aeroStorage.setItem("aero:guides",JSON.stringify(a))},getAll:function(f,d){if(aeroStorage.getItem("aero:guide:auto")){d=true;aeroStorage.removeItem("aero:guide:auto")}var e=null;var b=aeroStorage.getItem("aero:guides");var c=aeroStorage.getItem("aero:cache");var a=aeroStorage.getItem("aero:locale");if(!c){c=AeroStep.cache}if(!a){c=AeroStep.locale}c=parseInt(c);if(c!=AeroStep.cache||a!=AeroStep.locale){e=JSON.parse(b);aeroStorage.removeItem("aero:guides");b=null}if(!b||d){Aero.log("Loading from SS","success");Aero.send(Aero.model.guide.url,{enduser:Aero.constants.USERNAME},function(g){if(e){var h=g.length-e.length;if(h>0){$q("body").data("newguides",h)}}aeroStorage.setItem("aero:cache",AeroStep.cache);aeroStorage.setItem("aero:locale",AeroStep.locale);aeroStorage.setItem("aero:guides",JSON.stringify(g));if(f){f(g)}})}else{Aero.log("Loading from LS","success");f(JSON.parse(b))}},get:function(b,a){Aero.send(Aero.model.guide.url,{id:b},function(c){if(a){a(c)}})},getByTerm:function(a,b){Aero.send(Aero.model.guide.urlSearch,{term:a},function(c){if(b){b(c)}})},create:function(a,b){Aero.send(Aero.model.guide.url,a,function(c){Aero.model.guide.update(b,c)},"POST")},update:function(a,b){Aero.send(Aero.model.guide.url,a,function(){Aero.model.guide.update();if(b){b()}},"PUT")},destroy:function(a){Aero.send(Aero.model.guide.url,{id:a},function(){Aero.model.guide.update()},"DELETE")}};Aero.view.sidebar={setScrollable:function(){var c=$q(window).height()-($q(".aero-head").outerHeight()+$q(".aero-foot").outerHeight());var d=$q(".aero-guide-title").outerHeight();var b=$q(".aero-add-step").length>0?$q(".aero-add-step").outerHeight():0;$q(".aero-guides, .aero-steps").height(c-(d+b))},show:function(a,b){if(!b){b-750}$q(".aero-sidebar").stop().animate({right:"-50px"},b,"easeInOutBack",function(){}).addClass("open");if(a){aeroStorage.setItem("aero:sidebar:open",1,function(){},true)}},hide:function(a){$q(".aero-sidebar").stop().animate({right:-($q(".aero-sidebar").outerWidth(true))},300,"swing",function(){}).removeClass("open");if($q(".aero-admin-wrapper").length){$q(".aero-admin-wrapper").remove();$q("#aero-tab").css("left","-44px")}$q(".aero-blanket, .aero-edit-active").remove();if(a){aeroStorage.setItem("aero:sidebar:open",0,function(){},true)}},notify:function(){$q("#aero-tab").prepend('<span class="aero-not">'+$q("body").data("newguides")+"</span>")},setEvents:function(){var b=this;var a;window.onresize=function(){clearTimeout(a);a=setTimeout(function(){b.setScrollable();var c=$q(".aero-restrict");if(c.length==0){return}c.each(function(){Aero.view.guide.positionRestrict($q(this))})},100)};$q("body").off("click.atc").on("click.atc","#aero-tab a",function(){if($q(".aero-sidebar").hasClass("open")){b.hide(true)}else{b.show(true)}});$q("#aero-tab").draggable({axis:"y",distance:10,containment:"body",stop:function(c,d){aeroStorage.setItem("aero:session:tab",d.offset.top,function(){},true)}});$q(window).off("hashchange.hashn").on("hashchange.hashn",function(){Aero.hashChange=true;AeroStep.ready(function(){setTimeout(function(){Aero.hashChange=false;Aero.guide.init()},500)},AeroStep.required)})}};