"use strict";Aero.model.audit={key:"aero:session:audit",defaults:function(){return{user:Aero.constants.USERNAME,guideid:Aero.tip._guide.id,pathwayid:Aero.pathway.pathwayid,progress:0,perc:0,timeStart:"",timeStamp:this.getTime(),timeTotal:""}},get:function(){return JSON.parse(aeroStorage.getItem(this.key))},update:function(b){if(AeroStep.admin||!Aero.tip._guide){return}var a=JSON.parse(aeroStorage.getItem(this.key));if(a&&a.id!=""&&b.id==""){b.id=a.id}b.timeStamp=this.getTime();aeroStorage.setItem(this.key,JSON.stringify(b))},getTime:function(){var a=new Date();return a.getFullYear()+"-"+this.padZero(a.getMonth()+1)+"-"+this.padZero(a.getDate())+" "+this.padZero(a.getHours())+":"+this.padZero(a.getMinutes())+":"+this.padZero(a.getSeconds())},padZero:function(a){return("0"+a).slice(-2)}};Aero.view.audit={timeStart:0,timeTotal:0,setEvents:function(){var a=this;a.startTimer();$q(window).on("beforeunload",function(){Aero.audit.save()});$q(window).on("focus.aerof",function(){Aero.view.audit.startTimer()}).on("blur.aerob",function(){Aero.view.audit.stopTimer()})},removeEvents:function(){$q(window).off("blur.aerob focus.aerof")},startTimer:function(){this.timeStart=new Date().getTime()},stopTimer:function(){var a=new Date().getTime();this.timeTotal=(a-this.timeStart)+this.timeTotal}};Aero.audit={enabled:true,url:"api/audit",id:"",furthestStep:0,init:function(b){var a=true;Aero.audit.furthestStep=0;Aero.view.audit.timeTotal=0;if(AeroStep.admin||!Aero.constants.USERNAME||typeof Aero.tip._guide==="undefined"||!Aero.tip._guide||aeroStorage.getItem("aero:session:audit")){a=false}Aero.view.audit.setEvents();if(a){this.create(b)}else{b()}},create:function(c){if(AeroStep.admin){return}var a=this;var b=Aero.model.audit.defaults();b.timeStart=b.timeStamp;b.timeTotal=Aero.view.audit.timeTotal;Aero.send(this.url+"/create",{data:JSON.stringify(b)},function(d){a.id=d;b.id=d;Aero.model.audit.update(b);if(c){c()}},"GET")},update:function(){if(AeroStep.admin){return}var a=Aero.model.audit.get();var b=Aero.tip._current;if(b<this.furthestStep){return}else{this.furthestStep=b}a.progress=(b+1);a.perc=Math.round(((b+1)/Aero.tip._guide.step.length)*100);a.id=this.id;a.timeTotal=Aero.view.audit.timeTotal;Aero.model.audit.update(a)},save:function(b){if(AeroStep.admin||!Aero.tip._guide){return}var a=Aero.model.audit.get();if(a){Aero.view.audit.stopTimer();a.timeTotal=Aero.view.audit.timeTotal;Aero.view.audit.removeEvents();Aero.send(this.url+"/create",{data:JSON.stringify(a)},function(c){Aero.model.audit.update(a)},"GET")}if(b){b()}}};