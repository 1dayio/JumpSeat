"use strict";Aero.tip={options:{labels:{end:AeroStep.lang.finished,next:AeroStep.lang.next,prev:AeroStep.lang.prev},template:function(e){var k="",h="",b="",d="";var f=e.position?e.position:"top";var c=parseInt(Aero.tip._current)+1;var g=(Aero.tip._guide)?Aero.tip._guide.step.length:0;var j=(c/g)*100;if(isNaN(e.size)){k=(e.size&&e.size!="")?" aero-tip-"+e.size:""}else{k="' style='width:"+e.size+"px'"}if(e.showTitle){h='<div class="aero-tip-title">'+e.title+"</div>"}var a=e.multi?"":"<div class='aero-tip-nav clearfix'><div class='aero-progress'><span>"+c+" of "+g+"</span><span class='aero-needle'><span style='width:"+j+"%'></span></span></div></div>";if(!Aero.tip._guide){a=""}if(e.answers&&e.answers.length>0){b=Aero.view.quiz.render(e.answers,e.quizsize)}if(e.embed||e.youtube){d=Aero.view.media.render(e)}return"<div id='"+e.id+"' class='aero-tip aero-tip-"+f+k+"' style='display:none'><div class='aero-tip-arrow'></div><div class='aero-tip-body'>"+h+e.body+b+d+"</div>"+a+"<div class='aero-tip-draggable'></div></div>"}},spotlight:function(g,e){return;var b,d,f,a,c;b=$q(e.loc);b.addClass("ae-showElement ae-relativePosition");f=b.outerWidth()+10;a=b.outerHeight()+10;c=b.offset();d=$q('<div class="aero-remove ae-overlay" style="top: 0;bottom: 0; left: 0;right: 0;position: fixed;opacity: 0.8;"></div>');$q("body").append(d);d=$q("<div />").addClass("aero-remove ae-helperLayer").css({width:f,height:a,top:c.top-5,left:c.left-5});$q("body").append(d)},setGuide:function(d,c,b){var a=this;a._guide=false;aeroStorage.getItem("aero:session",function(e){if(e&&!b){a._guide=JSON.parse(e);Aero.view.step.render(a._guide);if(c){c()}}else{Aero.model.guide.byId(d,function(f){a._guide=f;Aero.view.step.render(a._guide);aeroStorage.setItem("aero:session",JSON.stringify(a._guide),function(){if(c){c()}},true)})}},true)},setStep:function(a,b){this._current=a;if(!b){aeroStorage.setItem("aero:session:current",a,function(){},true)}},redirect:function(a,k,l){var d=false;var e=/#$/;var c=/\/$/;var j=document.URL;var h=false;var b=(h||aeroStorage.override)?Aero.host:location.protocol+"//"+location.hostname+(location.port?":"+location.port:"");var g=l?l:b;if(a=="/#/"){d=true}if(!a){a=""}a=g+a;if(!d){if(e.test(j)){j=j.replace("#","")}if(c.test(j)){j=j.slice(0,-1)}}a=AeroStep.getSubURL(a);if(k=="all"){return false}if(k=="par"){j=j.split("?")[0];a=a.split("?")[0]}if(k=="anc"){j=j.split("#")[0];a=a.split("#")[0]}if(j!=a){var f=aeroStorage.getItem("aero:session:404");var m=(f)?(parseInt(f)+1):0;aeroStorage.setItem("aero:session:404",m);if(m>1){Aero.confirm({ok:AeroStep.lang.done,title:AeroStep.lang.notfound,msg:AeroStep.lang.urlloop+"</br></br><strong>"+a+"</strong>",onConfirm:function(){Aero.tip.stop()}})}else{if(Aero.navigating||Aero.tip._current==0){Aero.navigating=false;window.location=a;return true}Aero.confirm({ok:AeroStep.lang.oopst,cancel:AeroStep.lang.oopsm,title:AeroStep.lang.oops,msg:AeroStep.lang.oopsdesc,onConfirm:function(){window.location=a},onCancel:function(){Aero.tip.jumpTo(Aero.tip._current-1)}})}return true}return false},validate:function(){var b=true;var a=Aero.step.get(this._current);if(a.answers&&a.answers.length>0){b=Aero.view.quiz.validate(a)}return b},start:function(e,c,d){var b=c?c:0;var a=this;aeroStorage.getItem("aero:session:cds",function(f){if(!f){aeroStorage.setItem("aero:session:cds",Aero.host,function(){},true)}else{Aero.host=f}a._forward=true;a.setGuide(e,function(){if(Aero.constants.USERNAME){Aero.audit.init()}a.setNav();a.setStep(b);$q(".aero-restrict").remove();a.beforeShow(b,Aero.step.get(a._current))},d)},true)},stop:function(){if(!this.validate()){return}aeroStorage.setItem("aero:cache",0);var a=this.isReturnBranch();if(!a){if(Aero.tip._guide.step&&Aero.tip._current==(Aero.tip._guide.step.length-1)){this.sayCongrats()}this.setStep(null);this.hide(this._current);clearInterval(this.ob);Aero.tip._guide=null;AeroStep.session.destroy();Aero.guide.init()}},next:function(){if(!this.validate()){return}var a=Aero.step.get(this._current);this._forward=true;clearInterval(this.ob);aeroStorage.removeItem("aero:session:fake");if(a.next!=-1){this.hide(this._current);this.beforeShow(a.next,a)}},prev:function(){var a=Aero.step.get(this._current);this._forward=false;clearInterval(this.ob);aeroStorage.removeItem("aero:session:fake");if(a.prev!=-1){this.hide(this._current);this.beforeShow(a.prev,a)}},jumpTo:function(a){var b=Aero.step.get(a);this._forward=true;clearInterval(this.ob);Aero.jump=true;aeroStorage.removeItem("aero:session:fake");if(b){this.hide(this._current);this.beforeShow(a,b)}},findStep:function(b){var a=false;if(b.loc){a=b.isFrame?$q(b.framePath).contents().find(b.loc):$q(b.loc);if(a.length===0||!a.is(":visible")||a.css("visibility")=="hidden"){a=false}}return a},findStepTimeout:function(d,b){var a=this;if(Aero.hashChange){return}if(a.tries<d*2){Aero.timeFindStep=setTimeout(function(){a.hide(b-1);a.show(b);a.tries++},500)}else{clearTimeout(Aero.timeFindStep);var c=Aero.step.get(b);Aero.view.step.setState(b,"missing");if(c.miss=="alert"){this.renderException(c.alert,c.alertContent,true)}else{if(c.miss=="back"){Aero.view.step.setState(b,"missing");this.prev()}else{if(c.miss=="skip"){a.show(b+1)}else{if(c.miss=="skipto"){a.jumpTo(c.skipto);for(var b=Aero.tip._current;b<=c.skipto-1;b++){Aero.view.step.setState(b,"missing")}}else{this.renderException("Step is Missing","Sorry, we can't find that step - to fix this try: <ul><li>Using a more generic element</li><li>Use 'next item visible' for the navigation on your previous step</li><li>Increase the wait timer for finding this step</li></ul>",true)}}}}}},observe:function(b){var a=this;Aero.log("Observe","info");var c=Aero.step.get(b);a.ob=setInterval(function(){Aero.log("Observing","info");var d=a.findStep(c);if(d){a.next()}if(d||b!=a._current+1){clearInterval(a.ob)}},500)},beforeShow:function(i,step){var self=this;self.tries=1;var wait=200;var before=(this._forward)?step.beforeCode:this._guide.step[i].beforeCode;if(step.pause){wait=parseInt(step.pause)*1000}if(before){try{eval(before)}catch(err){Aero.log("Before show code is broken: "+err,"error")}}setTimeout(function(){if(!Aero.hashChange){self.show(i)}},wait)},show:function(b,g){var f,a,c;if(Aero.tip._guide.step.length==0){return}if(typeof b=="undefined"){b=this._current}if(!Aero.tip._guide||b>Aero.tip._guide.step.length||b<0){return}aeroStorage.setItem("aero:session:forward",true);c=Aero.step.get(b);if(c.sidebar){setTimeout("Aero.view.sidebar.hide();",100)}else{aeroStorage.getItem("aero:sidebar:open",function(d){if(!$q(".aero-sidebar").hasClass("open")&&d=="1"){Aero.view.sidebar.show()}},true)}a=this.findStep(c,b);this.setStep(b,g);if(AeroStep.admin&&aeroStorage.getItem("aero:session:fake")&&aeroStorage.getItem("aero:session:forwardUrl")!==document.URL){Aero.view.step.setState(aeroStorage.getItem("aero:session:fake"),"forward");return}else{if(this.redirect(c.url,c.noUrl,c.cds)){return}}aeroStorage.removeItem("aero:session:404");if(a){Aero.log("Found Step "+b,"success");if(c.mask&&c.mask!=""){a.mask(c.mask)}Aero.audit.update();if(AeroStep.admin){aeroStorage.setItem("aero:sidebar:cdshost",b+"~"+window.location.host,function(){},true);aeroStorage.setItem("aero:session:fake",b);aeroStorage.setItem("aero:session:forwardUrl",document.URL)}if(c.branch){c.position="orphan";c.size=500}f=$q(this.options.template(c));if(c.branch){f=this.renderBranch(f,c.branch,c.branchstep,c["return"])}f=this.buildNav(f,c);$q(".ae-active-el").removeClass("ae-active-el");a.addClass("ae-active-el");$q("body").append(f);Aero.view.step.setState(b);this.setPosition(a,f,c.position);this.setEvents(a,c.nav,f,c.position);this.scrollToElement(a)}else{if(c.tries&&c.tries>0){this.findStepTimeout(c.tries,b);return}else{if(!c.multi){Aero.log("Skipping step: "+b+" with loc:"+c.loc,"error");Aero.view.step.setState(b,"missing");if(b<Aero.tip._guide.step.length){if(this._forward){this.next()}else{this.prev()}}}}}var e=(this._forward)?1:-1;var h=false;if(this._forward&&Aero.step.get(b+e).multi||!this._forward&&c.multi){h=true}if(Aero.jump&&c.multi){h=true;e=-1;this._forward=false}if(h){this.show(b+e,true)}Aero.jump=null},hide:function(i){var step=Aero.step.get(i);$q(".aero-active, .aero-showElement").removeClass("aero-active aero-showElement aero-relativePosition");$q(".aero-tip, .aero-remove").remove();if(step.afterCode){try{eval(step.afterCode)}catch(err){Aero.log("After hide code is broken: "+err,"error")}}},buildNav:function(b,c){var d="";var a=false;if(!c.nav.next){a=true}if(!c.noNav){if(c.next==-1){d+="<a class='aero-btn-end'>"+this.options.labels.end+"</a>"}if(!c.noNext&&!a&&c.next!=-1){d+="<a class='aero-btn-next'>"+this.options.labels.next+"</a>"}if(!c.noPrev&&c.prev!=-1){d+="<a class='aero-btn-prev'>"+this.options.labels.prev+"</a>"}}b.find(".aero-tip-nav").append(d);return b},setPosition:function(k,b,c){var h={};var a=k.offset();var e=b.outerWidth()/2;var d=b.outerHeight();var j=a.left+(k.outerWidth()/2);var g=a.top+(k.outerHeight()/2);var f=b.find(".aero-tip-arrow");h.tLeft=e-(f.outerWidth()/2);h.tTop=(b.outerHeight()/2)-(f.outerHeight()/2);switch(c){case"top":h.left=j-e;h.top=a.top-d-b.find(".aero-tip-arrow").outerHeight();break;case"bottom":h.left=j-e;h.top=a.top+k.outerHeight();break;case"left":h.left=a.left-b.outerWidth()-b.find(".aero-tip-arrow").outerWidth();h.top=g-(d/2);break;case"right":h.left=a.left+k.outerWidth();h.top=g-(d/2);break;case"orphan":h.left=$q(window).width()/2-e;h.top=$q(window).height()/2-(d/2);break}h=this.containIn(document,b,h,c);$q(".aero-tip-top, .aero-tip-bottom").each(function(){f.css({left:h.tLeft})});$q(".aero-tip-left, .aero-tip-right").each(function(){f.css({top:h.tTop})});$q(".aero-tip-top").each(function(){f.css({top:"auto"})});b.css({left:h.left,top:h.top})},containIn:function(b,f,h,g){var d=$q(b).height();var j=$q(window).width();var e=h.left+f.outerWidth()-j;var c=h.top+f.outerHeight()-d;if(e>0){if(g=="bottom"||g=="top"){h.tLeft+=e}h.left-=e}if(h.left<0){if(g=="bottom"||g=="top"){h.tLeft+=h.left}h.left-=h.left}if(h.top<0){if(g=="left"||g=="right"){h.tTop+=h.top}h.top-=h.top}if(c>0&&g=="bottom"){if(g=="left"||g=="right"){h.tTop+=c}h.top-=c}var a=h.left+f.outerWidth();if(a>(j-270)){aeroStorage.getItem("aero:sidebar:open",function(k){Aero.view.sidebar.hide()},true)}else{aeroStorage.getItem("aero:sidebar:open",function(k){if(k=="1"){Aero.view.sidebar.show()}},true);if(g=="orphan"){h.left-=115}}return h},scrollToElement:function(a){var b=$q(".aero-tip:eq(0)");b.show();if(!a.visible()){var c=Aero.pos.isScrollable(a);if(c){c.stop().animate({scrollTop:c.scrollTop()+a.position().top-c.height()/2+a.height()/2},1000,function(){$q(".aero-tip").fadeIn(200)})}else{$q("body, html").stop().animate({scrollTop:b.offset().top-($q(window).height()/2)+(b.height())},1000,function(){$q(".aero-tip").fadeIn(200)})}b.hide()}else{b.hide();$q(".aero-tip").fadeIn(200)}$q(".aero-tip").fadeIn(200)},isReturnBranch:function(){var b=aeroStorage.getItem("aero:session:branch:returnid");var a=aeroStorage.getItem("aero:session:branch:returnto");if(!b){return false}aeroStorage.removeItem("aero:session:branch:returnid");aeroStorage.removeItem("aero:session:branch:returnto");Aero.confirm({ok:"Return",cancel:"End Guide",title:"Branch complete",msg:"You have completed this branch, we will now move you back to the original guide.",onConfirm:function(){Aero.tip.hide();Aero.tip.start(b,parseInt(a),true)},onCancel:function(){Aero.tip.stop()}});return true},renderBranch:function(f,c,e,d){var a=f.find(".aero-tip-body").html();var b=a+"<div class='aero-branch'></div>";setTimeout(function(){for(i in c){if(typeof c[i]=="string"){Aero.guide.get(c[i],function(g){if($q(".aero-branch").find("#b-"+g.id).length==0){$q(".aero-branch").append("<a id='b-"+g.id+"' data-returnid='"+Aero.tip._guide.id+"' data-returnto='"+d+"' data-guideid='"+g.id+"' class='aero-start'>"+g.title+"</a>")}$q(window).trigger("resize")})}}},250);f.find(".aero-tip-body").html(b);return f},renderException:function(e,a,b){var f="";if(b&&AeroStep.admin){f='<div class="aero-section aero-goto"><label>Go back to step:</label><select id="aero-goto">';for(var c=0;c<Aero.tip._guide.step.length;c++){var d=c==(Aero.tip._current-1)?'selected="selected"':"";f+="<option "+d+'value="'+c+'">'+(c+1)+": "+Aero.tip._guide.step[c].title+"</option>"}f+="</select></div>"}Aero.confirm({ok:"End Guide",cancel:b?"Go Back":"Ok",title:e,msg:a+f,onConfirm:function(){Aero.tip.stop()},onCancel:function(){if(b&&AeroStep.admin){Aero.tip.jumpTo($q("#aero-goto").val())}else{if(b){Aero.tip.prev()}}}})},setNav:function(){var a=this;$q("body").off("click.aPe").on("click.aPe",".aero-btn-prev",function(){Aero.navigating=true;a.prev()}).off("click.aEd").on("click.aEd",".aero-btn-end",function(){a.stop()})},sayCongrats:function(){aeroStorage.getItem("aero:session",function(b){var a=JSON.parse(b);if(!AeroStep.admin){Aero.confirm({ok:AeroStep.lang.done,title:AeroStep.lang.gfinished,msg:AeroStep.lang.congrats+a.title,onConfirm:function(){AeroStep.session.destroy()}})}},true)},setEvents:function(c,f,e,a){var b=this,d=false;$q(document).off("scroll.scw").on("scroll.scw"+Aero.tip._current,function(){b.setPosition(c,e,a)},250);$q('div *:not(".aero-steps")').off("scroll.scd").on("scroll.scd"+Aero.tip._current,function(){b.setPosition(c,e,a)},250);$q(".aero-tip").draggable({handle:"div.aero-tip-draggable"});$q(window).on("resize",function(){b.setPosition(c,e,a);Aero.view.sidebar.setScrollable()},250);aeroStorage.removeItem("aero:session:end");if(Aero.tip._current==(Aero.tip._guide.step.length-1)){aeroStorage.setItem("aero:session:end",1);d=true}$q("body").off("click.branchc").on("click.branchc",".aero-continue",function(){Aero.tip.next()});$q("body").off("click.branchs").on("click.branchs",".aero-start",function(){aeroStorage.setItem("aero:session:branch:returnid",$q(this).data("returnid"));aeroStorage.setItem("aero:session:branch:returnto",$q(this).data("returnto"));Aero.tip.hide();Aero.tip.start($q(this).data("guideid"),0,true)});$q("body").off("click.aNe").on("click.aNe",".aero-btn-next",function(){b.next()});for(var g in f){if(f.hasOwnProperty(g)){if(f[g]==-1){f[g]=Aero.tip._current+1}switch(g){case"next":$q("body").off("click.aNe").on("click.aNe",".aero-btn-next",function(){if(!b.validate()){return}Aero.navigating=true;b.setStep(f[g]);b.jumpTo(f[g])});break;case"click":c.off("click.aeronav").on("click.aeronav",c,function(){if(!b.validate()){return}if(d){if(!AeroStep.admin){b.stop()}return}Aero.navigating=true;b.setStep(f[g]);b.jumpTo(f[g])});break;case"mousedown":c.off("mousedown.aeronav").on("mousedown.aeronav",c,function(){if(!b.validate()){return}if(d){if(!AeroStep.admin){b.stop()}return}Aero.navigating=true;b.setStep(f[g]);b.jumpTo(f[g])});break;case"hover":c.off("mouseenter.aeronav").on("mouseenter.aeronav",c,function(){if(!b.validate()){return}setTimeout(function(){b.jumpTo(f[g])},500)});break;case"blur":c.focus();c.off("keydown.aeronav").on("keydown.aeronav",c,function(j){if(!b.validate()){return}var h=j.keyCode||j.which;if(h==13||h==9){b.jumpTo(f[g])}});break;case"unload":$q(window).off("beforeunload.aeronav").on("beforeunload.aeronav",function(){b.setStep(f[g])});break;case"observe":b.observe(b._current+1);break}}}}};